import{f as dt,b as J,v as kt,t as et,i as wt,s as Q,h as ht,j as Tt,S as ct,g as pt,C as bt,k as q,u as xt,c as Et,l as It,m as j,n as lt,o as Lt}from"./index.7bc02917.js";import{u as $t,P as Bt}from"./Prompts.aab93fc6.js";import{d as X,p as mt,r as k,aI as h,a7 as S,a8 as g,Q as T,X as Z,aO as tt,af as E,u as c,o as gt,a as st,a5 as N,bc as Dt,bw as Mt,ba as K,a6 as B,y as A,N as Ot,b as Pt,n as Nt,j as At,aK as Rt,ae as W,q as zt,aL as Ht,aJ as jt}from"./@vue.54607f99.js";import{C as qt}from"./ChatItem.774b4182.js";import{L as Ut,c as Vt,a as Ft}from"./operateAPI.d07bad00.js";import{E as Gt,M as Kt,S as Jt,H as Qt,u as Xt,a as Yt}from"./@tiptap.e68cba02.js";import{P as _t,a as ft,T as Wt}from"./prosemirror-state.903cf479.js";import{u as Zt}from"./useOperate.98adb4bd.js";import{u as te,b as ee}from"./vue-router.213ce790.js";import{v as se}from"./vue-i18n.efbbbf24.js";import"./pinia.ad627e1a.js";import"./js-cookie.711e9524.js";import"./@vueuse.dfe8520e.js";import"./lodash-es.3411939d.js";import"./dayjs.b1bb3b84.js";import"./@intlify.d87c91cf.js";import"./js-md5.820e2c50.js";import"./axios.3560a3fb.js";import"./fingerprintjs2.15a42352.js";import"./@ctrl.b082b0c1.js";import"./@popperjs.c3f81369.js";import"./async-validator.fb49d0f5.js";import"./vue.740c4698.js";import"./CreateOperate.4df0528f.js";import"./markdown-it.b78612f4.js";import"./entities.c5b8564c.js";import"./uc.micro.5b97656f.js";import"./mdurl.afcf0e92.js";import"./linkify-it.11d25e6c.js";import"./punycode.539237c3.js";import"./markdown-it-katex.9105f420.js";import"./katex.c592c5f9.js";import"./match-at.c2c4d56c.js";import"./prismjs.42fd26d0.js";import"./event-source-polyfill.454af690.js";import"./tippy.js.6638f4cc.js";import"./prosemirror-view.c8812119.js";import"./prosemirror-model.2d18793b.js";import"./orderedmap.20afc3da.js";import"./prosemirror-transform.18cbf34a.js";import"./prosemirror-keymap.64e16793.js";import"./w3c-keyname.a3821d5e.js";import"./prosemirror-commands.009b9b4a.js";import"./prosemirror-schema-list.cc5c4b30.js";import"./prosemirror-dropcursor.f1bd8d40.js";import"./prosemirror-gapcursor.6daa0df5.js";import"./prosemirror-history.eb3d6ec3.js";import"./rope-sequence.bc1c44a3.js";import"./vue-clipboard3.01c11cab.js";import"./clipboard.a5e12852.js";const at=Symbol(),ae={class:"chat-start"},ne={class:"description"},oe={class:"start-list"},ie={class:"start-item-info"},re={class:"title"},ce=["onClick"],le=X({__name:"ChatInit",setup(t){const{setInputString:a}=mt(at),s=k([{type:"chat.init.informationTitle",describeList:["chat.init.informationText1","chat.init.informationText2"],icon:"information"},{type:"chat.init.contentTitle",describeList:["chat.init.contentText1","chat.init.contentText2"],icon:"content"},{type:"chat.init.ideasTitle",describeList:["chat.init.ideasText1","chat.init.ideasText2"],icon:"ideas"}]);return(e,r)=>{const d=dt;return h(),S("div",ae,[g("h2",null,T(e.$t("chat.init.startText1")),1),g("p",ne,T(e.$t("chat.init.startText2")),1),g("div",oe,[(h(!0),S(Z,null,tt(c(s),(o,p)=>(h(),S("div",{key:p,class:"start-item"},[E(d,{"custom-style":!1,icon:`chat-${o.icon}`},null,8,["icon"]),g("div",ie,[g("p",re,T(e.$t(`${o.type}`)),1),g("ul",null,[(h(!0),S(Z,null,tt(o.describeList,_=>(h(),S("li",{key:_,onClick:w=>c(a)(e.$t(`${_}`),"chatInit")},T(e.$t(`${_}`)),9,ce))),128))])])]))),128))])])}}});const ue=J(le,[["__scopeId","data-v-af60a253"]]),de={key:1,class:"chat-box"},he=X({__name:"ChatList",setup(t){const a=k(null),s=k(null),{chatData:e,getDataLength:r,setFavorite:d,setCopy:o,setDeleteSingle:p,setRefresh:_,handleScroll:w}=mt(at),m=v=>{for(;!Array.from(v.classList).includes("pre-code");)v=v.parentNode;return v||null},f=v=>{if(Array.from(v.target.parentNode.classList).includes("code-header-copy")){const D=m(v.target).querySelector(".pre-code-body");o(D)}};return gt(()=>{document.addEventListener("click",f),a.value&&(s.value=new IntersectionObserver(async v=>{for(const I of v)I.isIntersecting&&(w(),e.total-r.value<=e.per_page&&s.value.disconnect())}),s.value.observe(a.value))}),st(()=>{document.removeEventListener("click",f),s.value&&s.value.disconnect()}),(v,I)=>{const D=kt;return c(r)?(h(),S("div",de,[Dt(g("div",{ref_key:"loadingRef",ref:a,class:"loading-row"},null,512),[[Mt,c(r)<c(e).total],[D,!0]]),(h(!0),S(Z,null,tt(c(e).data,(M,b)=>(h(),N(qt,{key:b,data:M,index:b,onFavorite:c(d),onCopy:c(o),onDelete:c(p),onRefresh:c(_)},{loading:K(()=>[M.noOperateStatus?(h(),N(Ut,{key:0,"class-name":"text-loading"})):B("",!0)]),_:2},1032,["data","index","onFavorite","onCopy","onDelete","onRefresh"]))),128))])):(h(),N(ue,{key:0}))}}});const pe=J(he,[["__scopeId","data-v-07266497"]]),me=Gt.create({name:"characterCount",addOptions(){return{limit:null,toastText:"",mode:"textSize"}},addStorage(){return{characters:()=>0,words:()=>0}},onBeforeCreate(){this.storage.characters=t=>{const a=(t==null?void 0:t.node)||this.editor.state.doc;return((t==null?void 0:t.mode)||this.options.mode)==="textSize"?a.textBetween(0,a.content.size," "," ").length:a.nodeSize},this.storage.words=t=>{const a=(t==null?void 0:t.node)||this.editor.state.doc;return a.textBetween(0,a.content.size," "," ").split(" ").filter(r=>r!=="").length}},addProseMirrorPlugins(){return[new _t({key:new ft("characterCount"),filterTransaction:(t,a)=>{const s=this.options.limit;if(!t.docChanged||s===0||s===null||s===void 0)return!0;const e=this.storage.characters({node:a.doc}),r=this.storage.characters({node:t.doc});if(r<=s||e>s&&r>s&&r<=e)return!0;if(e>s&&r>s&&r>e||!t.getMeta("paste"))return!1;const o=t.selection.$head.pos,p=r-s,_=o-p,w=o;return t.deleteRange(_,w),this.storage.characters({node:t.doc})>s?(et({message:wt.global.t(this.options.toastText,[s]),customClass:"bg-black-light"}),!1):!0}})]}}),ge=Kt.create({name:"highlightInput",inclusive:!1,excludes:"_",exitable:!0,spanning:!1,addOptions(){return{}},parseHTML(){return[{tag:"highlight-input"}]},addAttributes(){return{class:{default:"highlight-input",renderHTML:function(t){return{class:t.class}}}}},renderHTML({HTMLAttributes:t}){return["highlight-input",t,0]},addProseMirrorPlugins(){return[new _t({key:new ft("highlightInputPlugin"),props:{handleClick:t=>{var o,p,_;if(!t.editable)return!0;const a=t.state,s=t.state.selection,r=(o=s.$anchor.marks()[0])!=null?o:[],d=((_=(p=r==null?void 0:r.type)==null?void 0:p.name)!=null?_:"")==="highlightInput";if(s.head===s.anchor){const w=t.state.schema.marks.highlightInput,m=ut(t,w,{class:"highlight-input"});if(d){const f=fe(m,s.$anchor,a,{class:"highlight-input focused"});t.dispatch(f)}else t.dispatch(m)}return!0},handleDOMEvents:{blur:function(t){const a=t.state.schema.marks.highlightInput,s=ut(t,a,{class:"highlight-input"});t.dispatch(s)}}}})]}}),_e=(t,a)=>{for(const s of t)if(s.type===a)return s},ut=function(t,a,s){const e=t.state.tr,r=[];return t.state.doc.descendants((d,o)=>{_e(d.marks,a)&&r.push({node:d,pos:o})}),r.forEach(function(d){e.addMark(d.pos,d.pos+d.node.nodeSize,a.create(s))}),e},fe=function(t,a,s,e){const r=a.pos-a.textOffset,d=r+a.parent.child(a.index()).nodeSize,o=Wt.create(t.doc,r,d);return t.setSelection(o),t.addMark(r,d,s.schema.marks.highlightInput.create(e)),t},ve={key:0,class:"is-empty"},ye={key:1,class:"character-count"},Ce=X({__name:"Editor",props:{className:{type:String,default:""},initContent:{type:String,default:""},wordLimit:{type:Number,default:0},toastText:{type:String,default:""},showPlaceholder:{type:String,default:""}},setup(t,{expose:a}){const s=t,e=A(()=>o.value.storage.characterCount.characters()),r=A(()=>o.value&&o.value.isEmpty),d=k([Jt,ge,Qt.extend({addKeyboardShortcuts(){return{Enter:()=>this.editor.commands.setHardBreak()}}})]);Boolean(s.wordLimit)&&d.value.push(me.configure({limit:s.wordLimit,toastText:s.toastText}));const o=Xt({content:s.initContent,extensions:d.value});return a({editor:o,getEditorContent:()=>o.value.getText(),setEditorContent:m=>{typeof m=="string"&&(m=m.replace(/%style_tag_pre%/g,"<highlight-input>").replace(/%style_tag_next%/g,"</highlight-input>")),o.value.commands.setContent(m)},clearEditorContent:()=>{o.value.commands.clearContent()}}),(m,f)=>(h(),S("div",{class:Ot(t.className)},[E(c(Yt),{class:"editor-content",editor:c(o)},null,8,["editor"]),c(r)&&Boolean(t.showPlaceholder)?(h(),S("p",ve,T(m.$t(t.showPlaceholder)),1)):B("",!0),c(o)&&Boolean(t.wordLimit)?(h(),S("div",ye,T(c(e))+"/"+T(t.wordLimit),1)):B("",!0)],2))}});const Se=J(Ce,[["__scopeId","data-v-ff71f858"]]),ke=t=>Q({url:"/chat/list",method:"GET",params:t}),we=t=>Q({url:"/chat/clear-single",method:"POST",data:t}),Te=()=>Q({url:"/chat/clear",method:"POST"}),be=t=>Q({url:"/chat/chat",method:"POST",data:t}),xe=t=>`/chat/get-chat?question_id=${t.questionId}&answer_id=${t.answerId}`,Ee=()=>{var P,V;const t=ht(),a={id:1,chat_type:1,collection_type:0,user_id:(P=t.user.user_id)!=null?P:"",send_id:"10",reply_id:"1",content:"",create_at:0},s={id:1,chat_type:1,collection_type:0,user_id:(V=t.user.user_id)!=null?V:"",send_id:"1",reply_id:"1",content:"",create_at:0,noOperateStatus:!0},e=Pt({current_page:1,data:[],last_page:1,per_page:10,total:1}),r=k("end"),d=k(null),o=A(()=>e.data.length),p=A(()=>e.data.length-1),_=n=>e.data[n-1].id,w=n=>{n==="end"&&(e.data[p.value].noOperateStatus=!1),r.value=n},m=()=>r.value==="end"?!1:(et({message:i18n.t("chat.chatNow"),customClass:"bg-black-light toast-center"}),!0),f=async(n="init",i)=>{const C=await ke({page:n==="scroll"?e.current_page:1,per_page:i||e.per_page});v(n,C)},v=(n,i)=>{n==="scroll"?Object.assign(e,{total:i.total,current_page:i.current_page,last_page:i.last_page,per_page:i.per_page,data:[...i.data,...e.data]}):Object.assign(e,i)},I=async(n,i)=>{D(n),L(i);const C=await be({keyword:n,gpt_type:t.gptType});Vt({url:xe({questionId:C[0].id,answerId:C[1].id}),openCallback:()=>{new Tt().getUseTimes()},successCallback:(x,H)=>{d.value=H,x.message===ct.BEGIN?M(x):x.message!==ct.DONE?e.data[p.value].content+=x.message:(H.close(),b(),d.value=null)},errorCallback:()=>{e.data[p.value].content=i18n.t("chat.timeOut"),b(),f()}})},D=n=>{a.content=n,a.create_at=new Date().getTime()/1e3,s.create_at=new Date().getTime()/1e3,e.data.push({...a}),e.data.push({...s}),e.total+=2,w("start")},M=n=>{e.data[p.value-1].id=n.question_id,e.data[p.value].id=n.reply_id,w("chat")},b=()=>{e.data[p.value].noOperateStatus=!1,w("end");const n=document.querySelectorAll(".code-header-copy.hide");n.length&&n.forEach(i=>{i.classList.remove("hide")})},R=(n,i)=>{m()||pt({msg:i18n.t("chat.clearSingleChat")},async C=>{!C||we({id:`${n.id},${_(i)}`}).then(()=>{const x=o.value>e.per_page?o.value:e.per_page;f("delete",x),O("delete")})})},y=()=>{e.data=[],f()},z=(n,i)=>{if(m())return;const C=Boolean(n.collection_type)?0:1;Ft({type:bt.CHAT,question_id:_(i),answer_id:n.id,collection_type:C}).then(()=>{e.data[i-1].collection_type=C,e.data[i].collection_type=C,O("favorition")})},U=n=>{if(m())return;const{handleCopy:i}=Zt();i(n),O("copy")},O=n=>{q({event:"chat","event-action":n})},L=(n,i)=>{Nt(()=>{n.scrollTop=i!=null?i:n.scrollHeight})};return st(()=>{Boolean(d.value)&&d.value.close()}),{chatData:e,getDataLength:o,chatStatus:r,addChat:I,isChatNow:m,getListData:f,clearChatList:y,setFavorite:z,setCopy:U,setDeleteSingle:R,setScrollTo:L}},Ie=t=>(Ht("data-v-708402f1"),t=t(),jt(),t),Le={class:"chat"},$e=Ie(()=>g("br",null,null,-1)),Be={class:"chat-content"},De={class:"chat-bottom"},Me={class:"operate-content"},Oe={class:"editor-textarea"},Pe={class:"operate-button"},Ne={class:"right"},Ae={key:1,class:"mask"},Re=X({__name:"index",setup(t){const{chatData:a,getDataLength:s,chatStatus:e,addChat:r,isChatNow:d,getListData:o,clearChatList:p,setFavorite:_,setCopy:w,setDeleteSingle:m,setScrollTo:f}=Ee(),v=te(),I=se.exports.useI18n(),D=ee(),M=xt(),b=ht(),R=$t(),y=k(null),z=k(!1),U=k(!1),O=k(!0),L=k(null),P=k(!1),V=A(()=>b.vipType==="free"||!b.token),n=k(1e3),i=k(""),C=A(()=>j()?i.value:L.value?L.value.getEditorContent():""),x=u=>{j()?i.value=u:L.value.setEditorContent(u)},H=(u,l)=>{l==="chatInit"&&q({event:"chat","event-action":"recommended_clicks"}),x(u)},nt=()=>{const{name:u,value:l}=R.promptsToChat;x(l),q({event:"instruction","event-action":u,"event-label":l.replace(/%style_tag_pre%/g,"").replace(/%style_tag_next%/g,"")})},ot=()=>{b.token?d()||(z.value=!z.value):lt(v.path)},it=u=>{b.token||lt(v.path);let l="";u?l=u:j()?l=i.value.trim():l=L.value.getEditorContent().trim(),!(d()||!l)&&(b.hasUseTimes?(r(l,y.value),x(""),q({event:"chat","event-action":"send_message"})):Lt())},vt=()=>{d()||pt({msg:I.t("chat.clearChat")},async u=>{!u||Te().then(()=>{p()})})},yt=()=>{q({event:"chat","event-action":"upgrade_plan_clicks"}),D.push({name:"Subscriptions"})},Ct=async()=>{if(y.value){const{scrollHeight:u}=y.value;if(O.value&&a.current_page<a.last_page){O.value=!1;const l=u;a.current_page+=1,await o("scroll");const $=y.value.scrollHeight-l;f(y.value,$),O.value=!0}}},St=u=>{let l=a.data[u-1].content;l.length>n.value&&(l=l.substring(0,n.value)),it(l)};(async()=>{M.setMainLoading(!0),b.token?(await o(),P.value=!0,s.value&&f(y.value)):P.value=!0,M.setMainLoading(!1)})();const rt=()=>{const u=y.value,l=u.scrollHeight-u.scrollTop-u.clientHeight;U.value=l>300};return gt(()=>{y.value.addEventListener("scroll",rt),R.isToChat&&(nt(),R.setToChat(!1))}),st(()=>{y.value.removeEventListener("scroll",rt)}),At(a,u=>{if(u&&e.value!=="end"){const{scrollHeight:l,scrollTop:$,clientHeight:Y}=y.value;l-$-Y<30&&f(y.value)}}),Rt(at,{chatData:a,getDataLength:s,setFavorite:_,setCopy:w,setDeleteSingle:m,setRefresh:St,setInputString:H,handleScroll:Ct}),(()=>{j()&&et({message:I.t("mobile.toast"),customClass:"bg-black-light toast-center"})})(),(u,l)=>{const $=dt,Y=Et,F=It;return h(),S("div",Le,[c(V)?(h(),S("div",{key:0,class:"chat-assistant",onClick:yt},[g("p",null,[W(T(u.$t("chat.assistantText1"))+" ",1),$e,g("span",null,T(u.$t("chat.assistantText2")),1),W(" "+T(u.$t("chat.assistantText3"))+" ",1),E($,{"class-name":"assistant-click","custom-style":!1,icon:"chat-click"})])])):B("",!0),g("div",{ref_key:"chatScrollRef",ref:y,class:"chat-top"},[g("div",Be,[c(P)?(h(),N(pe,{key:0,onSetInputValue:H})):B("",!0)])],512),g("div",De,[g("div",Me,[g("div",Oe,[c(j)()?(h(),N(Y,{key:0,modelValue:c(i),"onUpdate:modelValue":l[0]||(l[0]=G=>zt(i)?i.value=G:null),type:"textarea","show-word-limit":"",maxlength:c(n),class:"chat-input",autosize:{minRows:1,maxRows:5},resize:"none",placeholder:u.$t("chat.inputPlaceholder")},null,8,["modelValue","maxlength","placeholder"])):(h(),N(Se,{key:1,ref_key:"editorRef",ref:L,"init-content":c(i),"word-limit":c(n),"class-name":"chat-tiptap","toast-text":"chat.wordLimit","show-placeholder":"chat.inputPlaceholder"},null,8,["init-content","word-limit"]))]),g("div",Pe,[E(F,{class:"instruction-btn",onClick:ot},{default:K(()=>[E($,{"class-name":"chat-instruction",icon:"chat-instruction"}),W(" "+T(u.$t("chat.instruction")),1)]),_:1}),g("div",Ne,[E(F,{disabled:!Boolean(c(C)),onClick:l[1]||(l[1]=G=>x(""))},{default:K(()=>[E($,{"class-name":Boolean(c(C))?"chat-empty":"chat-empty disable",size:28,icon:"chat-empty"},null,8,["class-name"])]),_:1},8,["disabled"]),E(F,{disabled:!Boolean(c(C).trim()),onClick:l[2]||(l[2]=G=>it())},{default:K(()=>[E($,{"class-name":Boolean(c(C).trim())?"chat-send":"chat-send disable",size:28,icon:"chat-send"},null,8,["class-name"])]),_:1},8,["disabled"])])]),c(U)?(h(),S("p",{key:0,class:"jump-btn",onClick:l[3]||(l[3]=G=>c(f)(c(y)))},T(u.$t("chat.jumpBtn")),1)):B("",!0),c(s)?(h(),S("p",{key:1,class:"clear-chat",onClick:vt},T(u.$t("chat.clearBtn")),1)):B("",!0)])]),c(z)?(h(),S("div",Ae,[E(Bt,{"class-name":"chat-prompts","is-popup":!0,onSetInputObject:nt,onClose:ot})])):B("",!0)])}}});const As=J(Re,[["__scopeId","data-v-708402f1"]]);export{As as default};
