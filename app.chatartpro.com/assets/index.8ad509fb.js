import{f as ut,b as K,v as St,t as dt,i as kt,s as Z,h as tt,j as Tt,S as rt,g as pt,C as wt,k as H,u as bt,c as xt,l as Et,m as F,n as ct,o as Lt}from"./index.feaeb45b.js";import{u as It,P as $t}from"./Prompts.d68dec73.js";import{d as J,p as ht,r as T,aI as p,a7 as S,a8 as _,Q as w,X as Y,aO as W,af as x,u as l,o as mt,a as et,a5 as N,bc as Bt,bw as Dt,ba as G,a6 as $,y as R,N as Ot,b as Mt,n as Pt,j as Nt,aK as Rt,ae as X,q as At,aL as zt,aJ as Ht}from"./@vue.54607f99.js";import{C as jt}from"./ChatItem.225a1dc5.js";import{L as Ut,c as Vt,a as qt}from"./Loading.a91c48c6.js";import{E as Ft,M as Gt,S as Kt,H as Jt,u as Qt,a as Xt}from"./@tiptap.e68cba02.js";import{P as gt,a as _t,T as Yt}from"./prosemirror-state.903cf479.js";import{u as Wt}from"./useOperate.5b1521cf.js";import{u as Zt,b as te}from"./vue-router.438671b5.js";import{v as ee}from"./vue-i18n.efbbbf24.js";import"./pinia.ad627e1a.js";import"./js-cookie.711e9524.js";import"./@vueuse.dfe8520e.js";import"./lodash-es.6c80442e.js";import"./dayjs.b1bb3b84.js";import"./@intlify.d87c91cf.js";import"./js-md5.820e2c50.js";import"./axios.3560a3fb.js";import"./fingerprintjs2.15a42352.js";import"./@ctrl.b082b0c1.js";import"./@popperjs.c3f81369.js";import"./vue.740c4698.js";import"./CreateOperate.0022555e.js";import"./markdown-it.b78612f4.js";import"./entities.c5b8564c.js";import"./uc.micro.5b97656f.js";import"./mdurl.afcf0e92.js";import"./linkify-it.11d25e6c.js";import"./punycode.539237c3.js";import"./markdown-it-katex.9105f420.js";import"./katex.c592c5f9.js";import"./match-at.c2c4d56c.js";import"./prismjs.42fd26d0.js";import"./event-source-polyfill.454af690.js";import"./tippy.js.6638f4cc.js";import"./prosemirror-view.c8812119.js";import"./prosemirror-model.2d18793b.js";import"./orderedmap.20afc3da.js";import"./prosemirror-transform.18cbf34a.js";import"./prosemirror-keymap.64e16793.js";import"./w3c-keyname.a3821d5e.js";import"./prosemirror-commands.009b9b4a.js";import"./prosemirror-schema-list.cc5c4b30.js";import"./prosemirror-dropcursor.f1bd8d40.js";import"./prosemirror-gapcursor.6daa0df5.js";import"./prosemirror-history.eb3d6ec3.js";import"./rope-sequence.bc1c44a3.js";import"./vue-clipboard3.01c11cab.js";import"./clipboard.a5e12852.js";const st=Symbol(),se={class:"chat-start"},ae={class:"description"},ne={class:"start-list"},oe={class:"start-item-info"},ie={class:"title"},re=["onClick"],ce=J({__name:"ChatInit",setup(t){const{setInputString:a}=ht(st),s=T([{type:"chat.init.informationTitle",describeList:["chat.init.informationText1","chat.init.informationText2"],icon:"information"},{type:"chat.init.contentTitle",describeList:["chat.init.contentText1","chat.init.contentText2"],icon:"content"},{type:"chat.init.ideasTitle",describeList:["chat.init.ideasText1","chat.init.ideasText2"],icon:"ideas"}]);return(e,i)=>{const u=ut;return p(),S("div",se,[_("h2",null,w(e.$t("chat.init.startText1")),1),_("p",ae,w(e.$t("chat.init.startText2")),1),_("div",ne,[(p(!0),S(Y,null,W(l(s),(o,h)=>(p(),S("div",{key:h,class:"start-item"},[x(u,{"custom-style":!1,icon:`chat-${o.icon}`},null,8,["icon"]),_("div",oe,[_("p",ie,w(e.$t(`${o.type}`)),1),_("ul",null,[(p(!0),S(Y,null,W(o.describeList,f=>(p(),S("li",{key:f,onClick:k=>l(a)(e.$t(`${f}`),"chatInit")},w(e.$t(`${f}`)),9,re))),128))])])]))),128))])])}}});const le=K(ce,[["__scopeId","data-v-af60a253"]]),ue={key:1,class:"chat-box"},de=J({__name:"ChatList",setup(t){const a=T(null),s=T(null),{chatData:e,getDataLength:i,setFavorite:u,setCopy:o,setDeleteSingle:h,setRefresh:f,handleScroll:k}=ht(st),m=y=>{for(;!Array.from(y.classList).includes("pre-code");)y=y.parentNode;return y||null},v=y=>{if(Array.from(y.target.parentNode.classList).includes("code-header-copy")){const B=m(y.target).querySelector(".pre-code-body");o(B)}};return mt(()=>{document.addEventListener("click",v),a.value&&(s.value=new IntersectionObserver(async y=>{for(const E of y)E.isIntersecting&&(k(),e.total-i.value<=e.per_page&&s.value.disconnect())}),s.value.observe(a.value))}),et(()=>{document.removeEventListener("click",v),s.value&&s.value.disconnect()}),(y,E)=>{const B=St;return l(i)?(p(),S("div",ue,[Bt(_("div",{ref_key:"loadingRef",ref:a,class:"loading-row"},null,512),[[Dt,l(i)<l(e).total],[B,!0]]),(p(!0),S(Y,null,W(l(e).data,(D,b)=>(p(),N(jt,{key:b,data:D,index:b,onFavorite:l(u),onCopy:l(o),onDelete:l(h),onRefresh:l(f)},{loading:G(()=>[D.noOperateStatus?(p(),N(Ut,{key:0,"class-name":"text-loading"})):$("",!0)]),_:2},1032,["data","index","onFavorite","onCopy","onDelete","onRefresh"]))),128))])):(p(),N(le,{key:0}))}}});const pe=K(de,[["__scopeId","data-v-07266497"]]),he=Ft.create({name:"characterCount",addOptions(){return{limit:null,toastText:"",mode:"textSize"}},addStorage(){return{characters:()=>0,words:()=>0}},onBeforeCreate(){this.storage.characters=t=>{const a=(t==null?void 0:t.node)||this.editor.state.doc;return((t==null?void 0:t.mode)||this.options.mode)==="textSize"?a.textBetween(0,a.content.size," "," ").length:a.nodeSize},this.storage.words=t=>{const a=(t==null?void 0:t.node)||this.editor.state.doc;return a.textBetween(0,a.content.size," "," ").split(" ").filter(i=>i!=="").length}},addProseMirrorPlugins(){return[new gt({key:new _t("characterCount"),filterTransaction:(t,a)=>{const s=this.options.limit;if(!t.docChanged||s===0||s===null||s===void 0)return!0;const e=this.storage.characters({node:a.doc}),i=this.storage.characters({node:t.doc});if(i<=s||e>s&&i>s&&i<=e)return!0;if(e>s&&i>s&&i>e||!t.getMeta("paste"))return!1;const o=t.selection.$head.pos,h=i-s,f=o-h,k=o;return t.deleteRange(f,k),this.storage.characters({node:t.doc})>s?(dt({message:kt.global.t(this.options.toastText,[s]),customClass:"bg-black-light"}),!1):!0}})]}}),me=Gt.create({name:"highlightInput",inclusive:!1,excludes:"_",exitable:!0,spanning:!1,addOptions(){return{}},parseHTML(){return[{tag:"highlight-input"}]},addAttributes(){return{class:{default:"highlight-input",renderHTML:function(t){return{class:t.class}}}}},renderHTML({HTMLAttributes:t}){return["highlight-input",t,0]},addProseMirrorPlugins(){return[new gt({key:new _t("highlightInputPlugin"),props:{handleClick:t=>{var o,h,f;if(!t.editable)return!0;const a=t.state,s=t.state.selection,i=(o=s.$anchor.marks()[0])!=null?o:[],u=((f=(h=i==null?void 0:i.type)==null?void 0:h.name)!=null?f:"")==="highlightInput";if(s.head===s.anchor){const k=t.state.schema.marks.highlightInput,m=lt(t,k,{class:"highlight-input"});if(u){const v=_e(m,s.$anchor,a,{class:"highlight-input focused"});t.dispatch(v)}else t.dispatch(m)}return!0},handleDOMEvents:{blur:function(t){const a=t.state.schema.marks.highlightInput,s=lt(t,a,{class:"highlight-input"});t.dispatch(s)}}}})]}}),ge=(t,a)=>{for(const s of t)if(s.type===a)return s},lt=function(t,a,s){const e=t.state.tr,i=[];return t.state.doc.descendants((u,o)=>{ge(u.marks,a)&&i.push({node:u,pos:o})}),i.forEach(function(u){e.addMark(u.pos,u.pos+u.node.nodeSize,a.create(s))}),e},_e=function(t,a,s,e){const i=a.pos-a.textOffset,u=i+a.parent.child(a.index()).nodeSize,o=Yt.create(t.doc,i,u);return t.setSelection(o),t.addMark(i,u,s.schema.marks.highlightInput.create(e)),t},fe={key:0,class:"is-empty"},ve={key:1,class:"character-count"},ye=J({__name:"Editor",props:{className:{type:String,default:""},initContent:{type:String,default:""},wordLimit:{type:Number,default:0},toastText:{type:String,default:""},showPlaceholder:{type:String,default:""}},setup(t,{expose:a}){const s=t,e=R(()=>o.value.storage.characterCount.characters()),i=R(()=>o.value&&o.value.isEmpty),u=T([Kt,me,Jt.extend({addKeyboardShortcuts(){return{Enter:()=>this.editor.commands.setHardBreak()}}})]);Boolean(s.wordLimit)&&u.value.push(he.configure({limit:s.wordLimit,toastText:s.toastText}));const o=Qt({content:s.initContent,extensions:u.value});return a({editor:o,getEditorContent:()=>o.value.getText(),setEditorContent:m=>{typeof m=="string"&&(m=m.replace(/%style_tag_pre%/g,"<highlight-input>").replace(/%style_tag_next%/g,"</highlight-input>")),o.value.commands.setContent(m)},clearEditorContent:()=>{o.value.commands.clearContent()}}),(m,v)=>(p(),S("div",{class:Ot(t.className)},[x(l(Xt),{class:"editor-content",editor:l(o)},null,8,["editor"]),l(i)&&Boolean(t.showPlaceholder)?(p(),S("p",fe,w(m.$t(t.showPlaceholder)),1)):$("",!0),l(o)&&Boolean(t.wordLimit)?(p(),S("div",ve,w(l(e))+"/"+w(t.wordLimit),1)):$("",!0)],2))}});const Ce=K(ye,[["__scopeId","data-v-ff71f858"]]),Se=t=>Z({url:"/chat/list",method:"GET",params:t}),ke=t=>Z({url:"/chat/clear-single",method:"POST",data:t}),Te=()=>Z({url:"/chat/clear",method:"POST"}),we=t=>{const a=tt();return`/chat/chat?keyword=${encodeURIComponent(t)}&gpt_type=${a.gptType}`},be=()=>{var P,U;const t=tt(),a={id:1,chat_type:1,collection_type:0,user_id:(P=t.user.user_id)!=null?P:"",send_id:"10",reply_id:"1",content:"",create_at:0},s={id:1,chat_type:1,collection_type:0,user_id:(U=t.user.user_id)!=null?U:"",send_id:"1",reply_id:"1",content:"",create_at:0,noOperateStatus:!0},e=Mt({current_page:1,data:[],last_page:1,per_page:10,total:1}),i=T("end"),u=T(null),o=R(()=>e.data.length),h=R(()=>e.data.length-1),f=n=>e.data[n-1].id,k=n=>{n==="end"&&(e.data[h.value].noOperateStatus=!1),i.value=n},m=()=>i.value==="end"?!1:(dt({message:i18n.t("chat.chatNow"),customClass:"bg-black-light toast-center"}),!0),v=async(n="init",r)=>{const g=await Se({page:n==="scroll"?e.current_page:1,per_page:r||e.per_page});y(n,g)},y=(n,r)=>{n==="scroll"?Object.assign(e,{total:r.total,current_page:r.current_page,last_page:r.last_page,per_page:r.per_page,data:[...r.data,...e.data]}):Object.assign(e,r)},E=(n,r)=>{B(n),L(r),Vt({url:we(n),openCallback:()=>{new Tt().getUseTimes()},successCallback:(g,M)=>{u.value=M,g.message===rt.BEGIN?D(g):g.message!==rt.DONE?e.data[h.value].content+=g.message:(M.close(),b(),u.value=null)},errorCallback:()=>{e.data[h.value].content=i18n.t("chat.timeOut"),b(),v()}})},B=n=>{a.content=n,a.create_at=new Date().getTime()/1e3,s.create_at=new Date().getTime()/1e3,e.data.push({...a}),e.data.push({...s}),e.total+=2,k("start")},D=n=>{e.data[h.value-1].id=n.question_id,e.data[h.value].id=n.reply_id,k("chat")},b=()=>{e.data[h.value].noOperateStatus=!1,k("end");const n=document.querySelectorAll(".code-header-copy.hide");n.length&&n.forEach(r=>{r.classList.remove("hide")})},A=(n,r)=>{m()||pt({msg:i18n.t("chat.clearChat")},async g=>{!g||ke({id:`${n.id},${f(r)}`}).then(()=>{const M=o.value>e.per_page?o.value:e.per_page;v("delete",M),O("delete")})})},C=()=>{e.data=[],v()},z=(n,r)=>{if(m())return;const g=Boolean(n.collection_type)?0:1;qt({type:wt.CHAT,question_id:f(r),answer_id:n.id,collection_type:g}).then(()=>{e.data[r-1].collection_type=g,e.data[r].collection_type=g,O("favorition")})},j=n=>{if(m())return;const{handleCopy:r}=Wt();r(n),O("copy")},O=n=>{H({event:"chat","event-action":n})},L=(n,r)=>{Pt(()=>{n.scrollTop=r!=null?r:n.scrollHeight})};return et(()=>{Boolean(u.value)&&u.value.close()}),{chatData:e,getDataLength:o,chatStatus:i,addChat:E,isChatNow:m,getListData:v,clearChatList:C,setFavorite:z,setCopy:j,setDeleteSingle:A,setScrollTo:L}},xe=t=>(zt("data-v-ea273ab0"),t=t(),Ht(),t),Ee={class:"chat"},Le=xe(()=>_("br",null,null,-1)),Ie={class:"chat-content"},$e={class:"chat-bottom"},Be={class:"operate-content"},De={class:"editor-textarea"},Oe={class:"operate-button"},Me={class:"right"},Pe={key:1,class:"mask"},Ne=J({__name:"index",setup(t){const{chatData:a,getDataLength:s,chatStatus:e,addChat:i,isChatNow:u,getListData:o,clearChatList:h,setFavorite:f,setCopy:k,setDeleteSingle:m,setScrollTo:v}=be(),y=Zt(),E=ee.exports.useI18n(),B=te(),D=bt(),b=tt(),A=It(),C=T(null),z=T(!1),j=T(!1),O=T(!0),L=T(null),P=T(!1),U=R(()=>b.vipType==="free"||!b.token),n=T(""),r=R(()=>F()?n.value:L.value?L.value.getEditorContent():""),g=c=>{F()?n.value=c:L.value.setEditorContent(c)},M=(c,d)=>{d==="chatInit"&&H({event:"chat","event-action":"recommended_clicks"}),g(c)},at=()=>{const{name:c,value:d}=A.promptsToChat;g(d),H({event:"instruction","event-action":c,"event-label":d.replace(/%style_tag_pre%/g,"").replace(/%style_tag_next%/g,"")})},nt=()=>{b.token?u()||(z.value=!z.value):ct(y.path)},ot=c=>{b.token||ct(y.path);let d="";c?d=c:F()?d=n.value.trim():d=L.value.getEditorContent().trim(),!(u()||!d)&&(b.hasUseTimes?(i(d,C.value),g(""),H({event:"chat","event-action":"send_message"})):Lt())},ft=()=>{u()||pt({msg:E.t("chat.clearChat")},async c=>{!c||Te().then(()=>{h()})})},vt=()=>{H({event:"chat","event-action":"upgrade_plan_clicks"}),B.push({name:"Subscriptions"})},yt=async()=>{if(C.value){const{scrollHeight:c}=C.value;if(O.value&&a.current_page<a.last_page){O.value=!1;const d=c;a.current_page+=1,await o("scroll");const I=C.value.scrollHeight-d;v(C.value,I),O.value=!0}}},Ct=c=>{const d=a.data[c-1].content;ot(d)};(async()=>{D.setMainLoading(!0),b.token?(await o(),P.value=!0,s.value&&v(C.value)):P.value=!0,D.setMainLoading(!1)})();const it=()=>{const c=C.value,d=c.scrollHeight-c.scrollTop-c.clientHeight;j.value=d>300};return mt(()=>{C.value.addEventListener("scroll",it),A.isToChat&&(at(),A.setToChat(!1))}),et(()=>{C.value.removeEventListener("scroll",it)}),Nt(a,c=>{if(c&&e.value!=="end"){const{scrollHeight:d,scrollTop:I,clientHeight:Q}=C.value;d-I-Q<30&&v(C.value)}}),Rt(st,{chatData:a,getDataLength:s,setFavorite:f,setCopy:k,setDeleteSingle:m,setRefresh:Ct,setInputString:M,handleScroll:yt}),(c,d)=>{const I=ut,Q=xt,V=Et;return p(),S("div",Ee,[l(U)?(p(),S("div",{key:0,class:"chat-assistant",onClick:vt},[_("p",null,[X(w(c.$t("chat.assistantText1"))+" ",1),Le,_("span",null,w(c.$t("chat.assistantText2")),1),X(" "+w(c.$t("chat.assistantText3"))+" ",1),x(I,{"class-name":"assistant-click","custom-style":!1,icon:"chat-click"})])])):$("",!0),_("div",{ref_key:"chatScrollRef",ref:C,class:"chat-top"},[_("div",Ie,[l(P)?(p(),N(pe,{key:0,onSetInputValue:M})):$("",!0)])],512),_("div",$e,[_("div",Be,[_("div",De,[l(F)()?(p(),N(Q,{key:0,modelValue:l(n),"onUpdate:modelValue":d[0]||(d[0]=q=>At(n)?n.value=q:null),type:"textarea","show-word-limit":"",maxlength:2e3,class:"chat-input",autosize:{minRows:1,maxRows:5},resize:"none",placeholder:c.$t("chat.inputPlaceholder")},null,8,["modelValue","placeholder"])):(p(),N(Ce,{key:1,ref_key:"editorRef",ref:L,"init-content":l(n),"word-limit":2e3,"class-name":"chat-tiptap","toast-text":"chat.wordLimit","show-placeholder":"chat.inputPlaceholder"},null,8,["init-content"]))]),_("div",Oe,[x(V,{class:"instruction-btn",onClick:nt},{default:G(()=>[x(I,{"class-name":"chat-instruction",icon:"chat-instruction"}),X(" "+w(c.$t("chat.instruction")),1)]),_:1}),_("div",Me,[x(V,{disabled:!Boolean(l(r)),onClick:d[1]||(d[1]=q=>g(""))},{default:G(()=>[x(I,{"class-name":Boolean(l(r))?"chat-empty":"chat-empty disable",size:28,icon:"chat-empty"},null,8,["class-name"])]),_:1},8,["disabled"]),x(V,{disabled:!Boolean(l(r).trim()),onClick:d[2]||(d[2]=q=>ot())},{default:G(()=>[x(I,{"class-name":Boolean(l(r).trim())?"chat-send":"chat-send disable",size:28,icon:"chat-send"},null,8,["class-name"])]),_:1},8,["disabled"])])]),l(j)?(p(),S("p",{key:0,class:"jump-btn",onClick:d[3]||(d[3]=q=>l(v)(l(C)))},w(c.$t("chat.jumpBtn")),1)):$("",!0),l(s)?(p(),S("p",{key:1,class:"clear-chat",onClick:ft},w(c.$t("chat.clearBtn")),1)):$("",!0)])]),l(z)?(p(),S("div",Pe,[x($t,{"class-name":"chat-prompts","is-popup":!0,onSetInputObject:at,onClose:nt})])):$("",!0)])}}});const Os=K(Ne,[["__scopeId","data-v-ea273ab0"]]);export{Os as default};
